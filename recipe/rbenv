#!/usr/bin/env bash
set -e 
function usage() {
  echo "Usage:[PREFIX=/path/to/prefix] $0 install_type #[user|global], default is user"
}
[ "$1" = "-h" -o "$1" = "--help" ] && usage && exit 1

install_type=${1:-user}
rbenv_repo=${RBENV_REPO:-https://github.com/sstephenson/rbenv.git}
pluger_repo=${PLUGER_REPO:-https://github.com/cao7113/rbenv-pluger.git}

## prepare
which git >/dev/null || { echo No git installed! && exit 1; }
#prefer PREFIX; if not set by type
if [ -n "$PREFIX" ];then
  rbenv_root=$PREFIX/rbenv
else
  case $install_type in
    user)
      rbenv_root=~/.rbenv
      ;;
    global|system)
      rbenv_root=/opt/rbenv
      ;;
    *)
      usage && exit 1
      ;;
  esac
fi
[ -d $rbenv_root ] && echo Has existed $rbenv_root! && exit 1
owner=${USER:-$LOGNAME} #override by env
perm="$owner:$owner"
cmd="mkdir -p $rbenv_root" && $cmd &>/dev/null || sudo $cmd 
[ "`stat --format '%U:%G' $rbenv_root`" = "$perm" ] || sudo chown -R $perm $rbenv_root

## get rbenv
[ -d $rbenv_root/.git ] || { 
git clone $rbenv_repo $rbenv_root 
mkdir -p $rbenv_root/shims #for path
mkdir -p $rbenv_root/cache && echo Recommend use cache for ruby-build install

plugins_root=$rbenv_root/plugins && mkdir -p $plugins_root
git clone $pluger_repo $plugins_root/rbenv-pluger
}

########################################
#     set shell init file
tmpfile=/tmp/rbenv.rc
cat <<-RCFILE >$tmpfile

#Generated by $0: set rbenv on `date`
export RBENV_ROOT=$rbenv_root #required
RCFILE
init_file=/etc/profile.d/rbenv.sh #default
if [ "$install_type" = "user" ];then
  init_file=~/.bashrc
  echo "export PATH=\$RBENV_ROOT/bin:\$PATH" >>$tmpfile
  echo "eval \"\$(rbenv init -)\"" >>$tmpfile
  if grep -q "set rbenv" $init_file; then
    echo Has set rbenv in file: $init_file
  else
    cat $tmpfile >>$init_file && echo Set rbenv in file: $init_file, reshell to take effect!
  fi
else
  echo "export PATH=\$RBENV_ROOT/shims:\$RBENV_ROOT/bin:\$PATH" >>$tmpfile #Actually: just need shim in PATH
  sudo mv -b $tmpfile $init_file && echo create a new file: $init_file, reboot to take effect!
fi

echo Ok, install rbenv into $rbenv_root, try: rbenv --version in new shell!
