#!/usr/bin/env bash
set -e 

function usage() {
  cat <<-Doc
  Usage: $0 [--debug]

  available optional environments:
   * RUBY_VERSION=2.0.0-p353   
   * PREFIX=/path/to/install/prefix
   * INSTALL_TYPE=user|system  default is user
   * RUBY_BUILD_CACHE_PATH cache dir for package 
   * CONFIGURE_OPTS="--disable-install-doc" do not install rdoc and capi

  run like: 

    RUBY_BUILD_CACHE_PATH=~/down RUBY_VERSION=2.0.0-p353 recipe/rbenv --debug
    
    or by url style:

    curl -L https://raw2.github.com/cao7113/rbenv-pluger/master/recipe/rbenv|RUBY_VERSION=2.1.0 RUBY_BUILD_CACHE_PATH=~/down bash

Doc
}
[ "$1" = "-h" -o "$1" = "--help" ] && usage && exit 1
[ "$1" = "-d" -o "$1" = "--debug" ] && set -x

install_type=${INSTALL_TYPE:-user}
rbenv_repo=${RBENV_REPO:-https://github.com/sstephenson/rbenv.git}
pluger_repo=${PLUGER_REPO:-https://github.com/cao7113/rbenv-pluger.git}
if [ -n "$RUBY_BUILD_CACHE_PATH" ];then
  [ -d "$RUBY_BUILD_CACHE_PATH" ]||mkdir -p "$RUBY_BUILD_CACHE_PATH"
  export RUBY_BUILD_CACHE_PATH
  echo ==using cache: $RUBY_BUILD_CACHE_PATH
fi
[ -n "$CONFIGURE_OPTS" ] &&  export CONFIGURE_OPTS

## prepare
which git >/dev/null || { echo No git installed! && exit 1; }
if [ -n "$PREFIX" ];then #prefer PREFIX
  rbenv_root=$PREFIX/rbenv
else
  case $install_type in
    user)
      rbenv_root=~/.rbenv
      ;;
    global|system)
      rbenv_root=/opt/rbenv
      ;;
    *)
      usage && exit 1
      ;;
  esac
fi
[ -d $rbenv_root ] && echo Has existed $rbenv_root! && exit 1
owner=${USER:-$LOGNAME} #override by env
perm="$owner:$owner"
cmd="mkdir -p $rbenv_root" && $cmd &>/dev/null || sudo $cmd 
[ "`stat --format '%U:%G' $rbenv_root`" = "$perm" ] || sudo chown -R $perm $rbenv_root

## set rbenv
[ -d $rbenv_root/.git ] || { 
git clone $rbenv_repo $rbenv_root 
mkdir -p $rbenv_root/shims #for path
mkdir -p $rbenv_root/cache && echo Recommend use cache for ruby-build install

plugins_root=$rbenv_root/plugins && mkdir -p $plugins_root
pluger_root=$plugins_root/rbenv-pluger
git clone $pluger_repo $pluger_root
}

bin_rbenv=$rbenv_root/bin/rbenv
$bin_rbenv pluger bundle default

#set for default-gems
if [ -f $pluger_root/etc/default-gems ];then
  ln -sb $pluger_root/etc/default-gems $rbenv_root/default-gems
fi

gemrc_file=$pluger_root/etc/dot.gemrc
if [ -f $gemrc_file ];then
  [ -e ~/.gemrc ]||cp $gemrc_file ~/.gemrc
  [ -e /etc/gemrc ]||sudo ln -s $gemrc_file /etc/gemrc
fi

########################################
#     set shell init file
tmpfile=/tmp/rbenv.rc
init_file=/etc/profile.d/rbenv.sh

cat <<-RCFILE >$tmpfile
#set rbenv generated by $0 on `date`
export RBENV_ROOT=$rbenv_root #required
RCFILE

if [ "$install_type" = "user" ];then
  init_file=~/.bashrc
  if grep -q "set rbenv" $init_file; then
    echo Has set rbenv in file: $init_file
  else
    cat <<-InitSet >>$init_file
if [ -e \$RBENV_ROOT ]; then
  export PATH=\$RBENV_ROOT/bin:\$PATH
  eval \"\$(rbenv init -)\"
fi
InitSet
    echo Set rbenv in file: $init_file, reshell to take effect!
  fi
else
  #Actually: just need shim in PATH
  echo "export PATH=\$RBENV_ROOT/shims:\$RBENV_ROOT/bin:\$PATH" >>$tmpfile 
  sudo mv -b $tmpfile $init_file 
  echo create a new file: $init_file, reboot to take effect!
fi
echo ==Installed rbenv into $rbenv_root, try: rbenv --version in new shell!

## install a ruby version
ruby_version=$RUBY_VERSION
if [ -n "$ruby_version" -a -f "$plugins_root/ruby-build/share/ruby-build/$ruby_version" ];then
  $bin_rbenv install -kv $ruby_version
fi

echo Ok, all things have done now with a new ruby version: $ruby_version! 
